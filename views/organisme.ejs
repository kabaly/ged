<!DOCTYPE html>
<html lang="en">
	<%-include('./component/head')%>

	<body class="hold-transition light-skin sidebar-mini theme-primary fixed">

		<div class="wrapper" id="app">
			<!--entete-->
			<header class="main-header">
				<div class="d-flex align-items-center logo-box pl-20">
					<a href="#" class="waves-effect waves-light nav-link rounded d-none
						d-md-inline-block push-btn" data-toggle="push-menu" role="button">
						<img src="../images/svg-icon/collapse.svg" class="img-fluid svg-icon"
							alt="">
					</a>
					<!-- Logo -->
					<a href="index.html" class="logo">
						<!-- logo-->
						<div class="logo-lg">
							<span class="light-logo"><h3>DGIM</h3></span>
							<span class="dark-logo"><h3>DGIM</h3></span>
						</div>
					</a>
				</div>
				<!-- Header Navbar -->
				<nav class="navbar navbar-static-top pl-10">
					<!-- Sidebar toggle button-->
					<div class="app-menu">
						<ul class="header-megamenu nav">
							<li class="btn-group nav-item d-md-none">
								<a href="#" class="waves-effect waves-light nav-link rounded push-btn"
									data-toggle="push-menu" role="button">
									<img src="../images/svg-icon/collapse.svg" class="img-fluid svg-icon"
										alt="">
								</a>
							</li>
							<li class="btn-group nav-item">
								<a href="#" data-provide="fullscreen" class="waves-effect waves-light
									nav-link rounded full-screen" title="Full Screen">
									<img src="../images/svg-icon/fullscreen.svg" class="img-fluid svg-icon"
										alt="">
								</a>
							</li>
							<li class="btn-group d-md-inline-flex d-none">
								<div class="search-bx ml-10">
									<form>
										<div class="input-group">
											<input type="search" class="form-control" placeholder="Search"
												aria-label="Search" aria-describedby="button-addon2">
											<div class="input-group-append">
												<button class="btn" type="submit" id="button-addon2"><img
														src="../images/svg-icon/search.svg" class="img-fluid"
														alt="search"></button>
											</div>
										</div>
									</form>
								</div>
							</li>
						</ul>
					</div>

					<div class="navbar-custom-menu r-side">
						<ul class="nav navbar-nav">
							<!-- Notifications -->
							<li class="dropdown notifications-menu">
								<a href="#" class="waves-effect waves-light dropdown-toggle"
									data-toggle="dropdown" title="Notifications">
									<img src="../images/svg-icon/notifications.svg" class="img-fluid
										svg-icon" alt="">
								</a>
								<ul class="dropdown-menu animated bounceIn">

									<li class="header">
										<div class="p-20">
											<div class="flexbox">
												<div>
													<h4 class="mb-0 mt-0">Notifications</h4>
												</div>
												<div>
													<a href="#" class="text-danger">Clear All</a>
												</div>
											</div>
										</div>
									</li>

									<li>
										<!-- inner menu: contains the actual data -->
										<ul class="menu sm-scrol">
											<li>
												<a href="#">
													<i class="fa fa-users text-info"></i> Curabitur id eros quis nunc
													suscipit blandit.
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-warning text-warning"></i> Duis malesuada justo eu
													sapien elementum, in semper diam posuere.
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-users text-danger"></i> Donec at nisi sit amet
													tortor commodo porttitor pretium a erat.
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-shopping-cart text-success"></i> In gravida mauris
													et nisi
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-user text-danger"></i> Praesent eu lacus in libero
													dictum fermentum.
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-user text-primary"></i> Nunc fringilla lorem
												</a>
											</li>
											<li>
												<a href="#">
													<i class="fa fa-user text-success"></i> Nullam euismod dolor ut
													quam interdum, at scelerisque ipsum imperdiet.
												</a>
											</li>
										</ul>
									</li>
									<li class="footer">
										<a href="#">View all</a>
									</li>
								</ul>
							</li>
							<!-- User Account-->
							<li class="dropdown user user-menu">
								<a href="#" class="waves-effect waves-light dropdown-toggle"
									data-toggle="dropdown" title="User">
									<img src="../images/svg-icon/user.svg" class="rounded svg-icon" alt=""
										/>
								</a>
								<ul class="dropdown-menu animated flipInX">
									<!-- User image -->
									<li class="user-header bg-img" style="background-image:
										url(../images/user-info.jpg)" data-overlay="3">
										<div class="flexbox align-self-center">
											<img src="../images/avatar/7.jpg" class="float-left rounded-circle"
												alt="User Image">
											<h4 class="user-name align-self-center">
												<span>Samuel Brus</span>
												<small>samuel@gmail.com</small>
											</h4>
										</div>
									</li>
									<!-- Menu Body -->
									<li class="user-body">
										<a class="dropdown-item" href="javascript:void(0)"><i class="ion
												ion-person"></i> My Profile</a>
										<a class="dropdown-item" href="javascript:void(0)"><i class="ion
												ion-bag"></i> My Balance</a>
										<a class="dropdown-item" href="javascript:void(0)"><i class="ion
												ion-email-unread"></i> Inbox</a>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="javascript:void(0)"><i class="ion
												ion-settings"></i> Account Setting</a>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="javascript:void(0)"><i
												class="ion-log-out"></i> Logout</a>
										<div class="dropdown-divider"></div>
										<div class="p-10"><a href="javascript:void(0)" class="btn btn-sm
												btn-rounded btn-success">View Profile</a></div>
									</li>
								</ul>
							</li>

							<!-- Control Sidebar Toggle Button -->


						</ul>
					</div>
				</nav>
			</header>
			<!-- entete -->

			<!--menu de navigation-->
			<%-include('./component/menu')%>
			<!-- Content Wrapper.
     Contains page content -->
			<div class="content-wrapper">
				<!-- Modal -->
				<div class="modal center-modal fade" id="modal-center" tabindex="-1">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Organisme</h5>
								<button type="button" class="close" data-dismiss="modal">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<div class="form-group row">
									<label class="col-form-label col-md-2">Libelle:</label>
									<div class="col-md-10">
										<input class="form-control" type="text" name="libelle"
											v-model="editedItem.libelle">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-form-label col-md-2">Description:</label>
									<div class="col-md-10">
										<textarea class="form-control " rows="4" cols="30"
											v-model="editedItem.description"></textarea>
									</div>
								</div>
							</div>
							<div class="modal-footer modal-footer-uniform">
								<button type="button" class="btn btn-danger"
									data-dismiss="modal">Annuller</button>
								<button v-if="editedIndex>-1" type="button" class="btn btn-success float-right"
									data-dismiss="modal" @click="save">modifier</button>
								<button v-else type="button" class="btn btn-success float-right"
									data-dismiss="modal" @click="save">Enrégistrer</button>
							</div>
						</div>
					</div>
				</div>
				<!-- /.modal -->
				<div class="col-12">
					<div class="box">
						<div class="box-header d-flex justify-content-between">
							<h4 class="box-title">Organismes</h4>
							<button type="button" class="waves-effect waves-light btn btn-primary
								mb-5 btn btn-md"
								data-toggle="modal" data-target="#modal-center" @click="close">Nouveau</button>
						</div>
						<div class="box-body">
							<alert-component
								v-bind:alert="alert">
							</alert-component>
							<div class="table-responsive">
								<table id="example1" class="table table-bordered table-striped">
									<thead>
										<tr>
											<th>Actions</th>
											<th>N°</th>
											<th>Organismes</th>
											<th>Code</th>
											<th>Description</th>
										</tr>
									</thead>
									<tbody>
										<tr v-for="(organisme,index) in organismes">
											<td>
												<button type="button" class="waves-effect waves-light btn
													btn-success mb-5 btn-md" data-toggle="modal" data-target="#modal-center" 
													@click="editItem(organisme)"><i class="fa fa-edit"></i></button>
												<button type="button" class="waves-effect waves-light btn btn-danger 
													mb-5 btn-md"  data-toggle="modal" data-target="#modal-danger" 
													@click="editItem(organisme)"
													><i class="fa fa-trash"></i></button>
											</td>
											<td>{{index+1}}</td>
											<td>{{organisme.libelle}}</td>
											<td>{{organisme.code}}</td>
											<td>{{organisme.description}}</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!--modal de suppression-->	
	<div class="modal modal-danger" id="modal-danger">
	  <div class="modal-dialog" style="width: 450px;">
		<div class="modal-content bg-danger" style="width: 450px;">
		  <div class="modal-header" style="width: 450px;">
			<h4 class="modal-title">suppression !</h4>
			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true">&times;</span></button>
		  </div>
		  <div class="modal-body  bg-default">
			<h4>voulez vous supprimmer {{editedItem.libelle}}</h4>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-md btn-danger" data-dismiss="modal">Non</button>
			<button type="button" class="btn btn-md btn-primary float-right" data-dismiss="modal" 
			@click="deleteOrganisme">Oui</button>
		  </div>
		</div>
		<!-- /.modal-content -->
	  </div>
	  <!-- /.modal-dialog -->
 	</div>
			<!-- /.content-wrapper -->
			<footer class="main-footer">
				<div class="pull-right d-none d-sm-inline-block">
					<ul class="nav nav-primary nav-dotted nav-dot-separated
						justify-content-center justify-content-md-end">
						<li class="nav-item">
							<a class="nav-link" href="javascript:void(0)">FAQ</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Purchase Now</a>
						</li>
					</ul>
				</div>
				&copy; 2020 <a href="https://www.multipurposethemes.com/">Multipurpose
					Themes</a>. All Rights Reserved.
			</footer>
		</div>
		<!-- ./wrapper -->

		<!-- Vendor JS -->
		
		<%-include('./component/script')%>
		<script>
		var app = new Vue({
			el: '#app',
			data: {
				editedItem:{
					libelle:'',
                    description: '',
				},
				defaultItem: {
					libelle:'',
                    description: '',
				},
				editedIndex:null,
				organismes:[],
				alert: null	
			},
			created(){
				if(JSON.parse(localStorage.getItem('token'))==null){
					//window.location="/"
				}
				this.initialize()
			},
			beforeMount(){
				if(JSON.parse(localStorage.getItem('token'))==null){
					//window.location="/"
				}
				this.initialize()
			},
			methods : {
				 async initialize(){
					await new ApiService().findAll('/organisme/crud/')
					.then( response => {
						this.organismes=response.data
					})
					.catch(error =>{
						console.log(error);
					})
				},
					close () {
					this.$nextTick(() => {
					this.editedItem = Object.assign({}, this.defaultItem)
					this.editedIndex = -1
					})
      				},
					editItem (item) {
						console.log("lancer");
						this.editedIndex = this.organismes.indexOf(item)
						this.editedItem = Object.assign({}, item)
					},
					save(){
						if(this.editedIndex>-1){
							this.update()
						}else{
							this.addOrganisme()
						}
						this.close()
					},
					deleteOrganisme(){
						new ApiService().delete('/organisme/crud/',this.editedItem.id)
						.then(res=>{
							console.log(res);
							this.initialize()
							this.alert = new Alert().flash(
								'success',
								true,
								'Suppression effectuée !'
							)
						}).catch(err=>{
							this.alert = new Alert().flash(
								'danger',
								true,
								"erreur de suppression !"
							)
						})
					},
					update(){
						if(new Alert().validateRequestData(this.editedItem)) {
						new ApiService().update('/organisme/crud/',this.editedItem,this.editedItem.id)
						.then(res=>{
							console.log(res);
							this.initialize()
							this.alert = new Alert().flash(
								'success',
								true,
								'modification effectuée !'
							)
						}).catch(err=>{
							this.alert = new Alert().flash(
								'danger',
								true,
								"erreur de modification !"
							)
						})}else{
							this.alert = new Alert().flash('error', true, 'Tous les champs sont obligatoires')
						}
					},
					addOrganisme(){
					if(new Alert().validateRequestData(this.editedItem)) {
						new ApiService().add('/organisme/crud/',this.editedItem)
						.then( response => {
							this.organismes=response.data
							this.alert = new Alert().flash(
								'success',
								true,
								'Organisme ajouté avec succès !'
							)
							this.initialize()
						})
						.catch(error =>{
							console.log(error);
							this.alert = new Alert().flash(
								'danger',
								true,
								"erreur d'ajout !"
							)
						})
					}else {
						this.alert = new Alert().flash('error', true, 'Tous les champs sont obligatoires')
					}
				}
			}
		})
		
	</script>
	</body>
</html>
